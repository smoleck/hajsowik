<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
        form { margin-bottom: 20px; }
        #editModal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
            width: 300px;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>

<h1>Panel użytkownika</h1>

<!-- ✅ Lista kont -->
<h2>Twoje konta</h2>
<table id="accountsTable">
    <thead>
    <tr>
        <th>Nazwa</th>
        <th>Bank</th>
        <th>Saldo</th>
        <th>Akcje</th>
    </tr>
    </thead>
    <tbody id="accountsBody"></tbody>
</table>

<!-- ✅ Formularz dodawania konta -->
<h2>Dodaj konto</h2>
<form id="addAccountForm">
    <label>Nazwa:</label>
    <input type="text" id="accountName" required>
    <label>Bank:</label>
    <input type="text" id="accountBank" required>
    <label>Saldo początkowe:</label>
    <input type="number" id="accountBalance" step="0.01" required>
    <button type="submit">Dodaj</button>
</form>

<!-- ✅ Formularz przelewu -->
<h2>Przelew między kontami</h2>
<form id="transferForm">
    <label>Z konta:</label>
    <select id="fromAccount" required></select>
    <label>Na konto:</label>
    <select id="toAccount" required></select>
    <label>Kwota:</label>
    <input type="number" id="amount" step="0.01" required>
    <button type="submit">Wykonaj przelew</button>
</form>

<!-- ✅ Modal edycji konta -->
<div id="overlay"></div>
<div id="editModal">
    <h3>Edytuj konto</h3>
    <form id="editForm">
        <input type="hidden" id="editId">
        <label>Nazwa:</label>
        <input type="text" id="editName" required>
        <label>Bank:</label>
        <input type="text" id="editBank" required>
        <label>Saldo:</label>
        <input type="number" id="editBalance" step="0.01" required>
        <button type="submit">Zapisz</button>
        <button type="button" onclick="closeEditModal()">Anuluj</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadAccounts();

        // ✅ Obsługa dodawania konta
        document.getElementById('addAccountForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('accountName').value,
                bank: document.getElementById('accountBank').value,
                balance: parseFloat(document.getElementById('accountBalance').value)
            };

            const response = await fetch('/api/accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            if (response.ok) {
                e.target.reset();
                await loadAccounts();
            } else {
                alert('Błąd podczas dodawania konta');
            }
        });

       // ✅ Obsługa przelewu
document.getElementById('transferForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const data = {
        fromAccountId: document.getElementById('fromAccount').value,
        toAccountId: document.getElementById('toAccount').value,
        amount: parseFloat(document.getElementById('amount').value)
    };

    try {
        const response = await fetch('/api/transfer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
            credentials: 'same-origin'
        });

        if (response.ok) {
            const result = await response.json();
            e.target.reset();
            await loadAccounts();
        } else {
            const error = await response.json();
            alert(error.error || 'Błąd podczas przelewu ❌');
        }
    } catch (err) {
        alert('Błąd sieci lub serwera ❌');
        console.error(err);
    }
});
        // ✅ Obsługa edycji
        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('editName').value,
                bank: document.getElementById('editBank').value,
                balance: parseFloat(document.getElementById('editBalance').value)
            };

            const response = await fetch('/api/accounts/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            if (response.ok) {
                closeEditModal();
                await loadAccounts();
            } else {
                alert('Błąd podczas edycji');
            }
        });
    });

    async function loadAccounts() {
        const response = await fetch('/api/accounts', {credentials: 'same-origin'});
        const accounts = await response.json();

        const tbody = document.getElementById('accountsBody');
        tbody.innerHTML = '';
        const fromSelect = document.getElementById('fromAccount');
        const toSelect = document.getElementById('toAccount');
        fromSelect.innerHTML = '';
        toSelect.innerHTML = '';

        accounts.forEach(account => {
            const row = `<tr>
                <td>${account.name}</td>
                <td>${account.bank}</td>
                <td>${account.balance.toFixed(2)}</td>
                <td>
                    <button onclick="openEditModal(${account.id}, '${account.name}', '${account.bank}', ${account.balance})">Edytuj</button>
                    <button onclick="deleteAccount(${account.id})">Usuń</button>
                </td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);

            fromSelect.insertAdjacentHTML('beforeend', `<option value="${account.id}">${account.name}</option>`);
            toSelect.insertAdjacentHTML('beforeend', `<option value="${account.id}">${account.name}</option>`);
        });
    }

    function openEditModal(id, name, bank, balance) {
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editBank').value = bank;
        document.getElementById('editBalance').value = balance;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editModal').style.display = 'none';
    }

    async function deleteAccount(id) {
        if (!confirm('Czy na pewno chcesz usunąć to konto?')) return;

        const response = await fetch('/api/accounts/' + id, {
            method: 'DELETE',
            credentials: 'same-origin'
        });

        if (response.ok) {
            await loadAccounts();
        } else {
            alert('Błąd podczas usuwania');
        }
    }
</script>

</body>
</html>