<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
        form { margin-bottom: 20px; }
        #editModal, #editTransactionModal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
            width: 350px;
        }
        #overlay, #transactionOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>

<h1>Panel użytkownika</h1>

<!-- ✅ Lista kont -->
<h2>Twoje konta</h2>
<table id="accountsTable">
    <thead>
    <tr>
        <th>Nazwa</th>
        <th>Saldo</th>
        <th>Akcje</th>
    </tr>
    </thead>
    <tbody id="accountsBody"></tbody>
</table>

<!-- ✅ Formularz dodawania konta -->
<h2>Dodaj konto</h2>
<form id="addAccountForm">
    <label>Nazwa:</label>
    <input type="text" id="accountName" required>
    <label>Saldo początkowe:</label>
    <input type="number" id="accountBalance" step="0.01" required>
    <button type="submit">Dodaj</button>
</form>

<!-- ✅ Formularz przelewu -->
<h2>Przelew między kontami</h2>
<form id="transferForm">
    <label>Z konta:</label>
    <select id="fromAccount" required></select>
    <label>Na konto:</label>
    <select id="toAccount" required></select>
    <label>Kwota:</label>
    <input type="number" id="amount" step="0.01" required>
    <button type="submit">Wykonaj przelew</button>
</form>

<!-- ✅ Historia transakcji -->
<h2>Historia transakcji</h2>
<table id="transactionsTable">
    <thead>
    <tr>
        <th>Nazwa</th>
        <th>Kwota</th>
        <th>Kategoria</th>
        <th>Typ</th>
        <th>Data</th>
        <th>Konto</th>
        <th>Akcje</th>
    </tr>
    </thead>
    <tbody id="transactionsBody"></tbody>
</table>

<!-- ✅ Formularz dodawania transakcji -->
<h2>Dodaj transakcję</h2>
<form id="addTransactionForm">
    <label>Nazwa:</label>
    <input type="text" id="transactionName" required>
    <label>Kwota:</label>
    <input type="number" id="transactionAmount" step="0.01" required>
    <label>Kategoria:</label>
    <input type="text" id="transactionCategory">
    <label>Typ:</label>
    <select id="transactionType" required>
        <option value="INCOME">Przychód</option>
        <option value="EXPENSE">Wydatek</option>
    </select>
    <label>Konto:</label>
    <select id="transactionAccount" required></select>
    <button type="submit">Dodaj</button>
</form>

<!-- ✅ Modal edycji konta -->
<div id="overlay"></div>
<div id="editModal">
    <h3>Edytuj konto</h3>
    <form id="editForm">
        <input type="hidden" id="editId">
        <label>Nazwa:</label>
        <input type="text" id="editName" required>
        <input type="number" id="editBalance" step="0.01" required>
        <button type="submit">Zapisz</button>
        <button type="button" onclick="closeEditModal()">Anuluj</button>
    </form>
</div>

<!-- ✅ Modal edycji transakcji -->
<div id="transactionOverlay"></div>
<div id="editTransactionModal">
    <h3>Edytuj transakcję</h3>
    <form id="editTransactionForm">
        <input type="hidden" id="editTransactionId">
        <label>Nazwa:</label>
        <input type="text" id="editTransactionName" required><br>
        <label>Kwota:</label>
        <input type="number" id="editTransactionAmount" step="0.01" required><br>
        <label>Kategoria:</label>
        <input type="text" id="editTransactionCategory"><br>
        <label>Typ:</label>
        <select id="editTransactionType" required>
            <option value="INCOME">Przychód</option>
            <option value="EXPENSE">Wydatek</option>
        </select><br>
        <button type="submit">Zapisz</button>
        <button type="button" onclick="closeEditTransactionModal()">Anuluj</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadAccounts();
        loadTransactions();

        // ✅ Dodawanie konta
        document.getElementById('addAccountForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('accountName').value,
                balance: parseFloat(document.getElementById('accountBalance').value)
            };

            const response = await fetch('/api/accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            if (response.ok) {
                e.target.reset();
                await loadAccounts();
            } else {
                alert('Błąd podczas dodawania konta');
            }
        });

        // ✅ Przelew
        document.getElementById('transferForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const data = {
                fromAccountId: document.getElementById('fromAccount').value,
                toAccountId: document.getElementById('toAccount').value,
                amount: parseFloat(document.getElementById('amount').value)
            };

            try {
                const response = await fetch('/api/transfer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data),
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    e.target.reset();
                    await loadAccounts();
                    await loadTransactions();
                } else {
                    alert('Błąd podczas przelewu ❌');
                }
            } catch (err) {
                alert('Błąd sieci lub serwera ❌');
                console.error(err);
            }
        });

        // ✅ Dodawanie transakcji
        document.getElementById('addTransactionForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const accountId = document.getElementById('transactionAccount').value;
            const data = {
                name: document.getElementById('transactionName').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                type: document.getElementById('transactionType').value,
                date: new Date().toISOString()
            };

            const response = await fetch('/api/transactions/' + accountId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            if (response.ok) {
                e.target.reset();
                await loadTransactions();
                await loadAccounts();
            } else {
                alert('Błąd podczas dodawania transakcji ❌');
            }
        });

        // ✅ Edycja konta
        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('editName').value,
                balance: parseFloat(document.getElementById('editBalance').value)
            };

            const response = await fetch('/api/accounts/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            if (response.ok) {
                closeEditModal();
                await loadAccounts();
            } else {
                alert('Błąd podczas edycji');
            }
        });

        // ✅ Edycja transakcji
        document.getElementById('editTransactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('editTransactionId').value;
            const data = {
                name: document.getElementById('editTransactionName').value,
                amount: parseFloat(document.getElementById('editTransactionAmount').value),
                category: document.getElementById('editTransactionCategory').value,
                type: document.getElementById('editTransactionType').value,
                date: new Date().toISOString()
            };

            const response = await fetch('/api/transactions/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            if (response.ok) {
                closeEditTransactionModal();
                await loadTransactions();
                await loadAccounts();
            } else {
                alert("Błąd przy edycji transakcji ❌");
            }
        });
    });

    // ✅ Załaduj konta
    async function loadAccounts() {
        const response = await fetch('/api/accounts', {credentials: 'same-origin'});
        const accounts = await response.json();

        const tbody = document.getElementById('accountsBody');
        tbody.innerHTML = '';
        const fromSelect = document.getElementById('fromAccount');
        const toSelect = document.getElementById('toAccount');
        const transactionAccount = document.getElementById('transactionAccount');
        fromSelect.innerHTML = '';
        toSelect.innerHTML = '';
        transactionAccount.innerHTML = '';

        accounts.forEach(account => {
            const row = `<tr>
                <td>${account.name}</td>
                <td>${account.balance.toFixed(2)}</td>
                <td>
                    <button onclick="openEditModal(${account.id}, '${account.name}', ${account.balance})">Edytuj</button>
                    <button onclick="deleteAccount(${account.id})">Usuń</button>
                </td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);

            fromSelect.insertAdjacentHTML('beforeend', `<option value="${account.id}">${account.name}</option>`);
            toSelect.insertAdjacentHTML('beforeend', `<option value="${account.id}">${account.name}</option>`);
            transactionAccount.insertAdjacentHTML('beforeend', `<option value="${account.id}">${account.name}</option>`);
        });
    }

    // ✅ Załaduj transakcje
    async function loadTransactions() {
        const response = await fetch('/api/transactions', {credentials: 'same-origin'});
        const transactions = await response.json();

        const tbody = document.getElementById('transactionsBody');
        tbody.innerHTML = '';

        transactions.forEach(tx => {
            const row = `<tr>
                <td>${tx.name}</td>
                <td>${tx.amount.toFixed(2)}</td>
                <td>${tx.category || '-'}</td>
                <td>${tx.type}</td>
                <td>${new Date(tx.date).toLocaleDateString()}</td>
                <td>${tx.account ? tx.account.name : '-'}</td>
                <td>
                    <button onclick="openEditTransactionModal(${tx.id}, '${tx.name}', ${tx.amount}, '${tx.category || ''}', '${tx.type}')">Edytuj</button>
                    <button onclick="deleteTransaction(${tx.id})">Usuń</button>
                </td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    // ✅ Modal konto
    function openEditModal(id, name, balance) {
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editBalance').value = balance;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editModal').style.display = 'block';
    }
    function closeEditModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editModal').style.display = 'none';
    }

    // ✅ Modal transakcja
    function openEditTransactionModal(id, name, amount, category, type) {
        document.getElementById('editTransactionId').value = id;
        document.getElementById('editTransactionName').value = name;
        document.getElementById('editTransactionAmount').value = amount;
        document.getElementById('editTransactionCategory').value = category || '';
        document.getElementById('editTransactionType').value = type;
        document.getElementById('transactionOverlay').style.display = 'block';
        document.getElementById('editTransactionModal').style.display = 'block';
    }
    function closeEditTransactionModal() {
        document.getElementById('transactionOverlay').style.display = 'none';
        document.getElementById('editTransactionModal').style.display = 'none';
    }

    // ✅ Usuń konto
    async function deleteAccount(id) {
        if (!confirm('Czy na pewno chcesz usunąć to konto?')) return;
        const response = await fetch('/api/accounts/' + id, {method: 'DELETE', credentials: 'same-origin'});
        if (response.ok) {
            await loadAccounts();
            await loadTransactions();
        } else {
            alert('Błąd podczas usuwania');
        }
    }

    // ✅ Usuń transakcję
    async function deleteTransaction(id) {
        if (!confirm('Czy na pewno chcesz usunąć tę transakcję?')) return;
        const response = await fetch('/api/transactions/' + id, {method: 'DELETE', credentials: 'same-origin'});
        if (response.ok) {
            await loadTransactions();
            await loadAccounts();
        } else {
            alert('Błąd podczas usuwania transakcji');
        }
    }
</script>

</body>
</html>